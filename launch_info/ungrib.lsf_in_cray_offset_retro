#! /bin/sh

# #BSUB -oo /gpfs/hps3/emc/meso/noscrub/Matthew.Pyle/hiresw.v7.0.0/logs/test_ungrib.out__DOM___CORE_
# #BSUB -eo /gpfs/hps3/emc/meso/noscrub/Matthew.Pyle/hiresw.v7.0.0/logs/test_ungrib.err__DOM___CORE_
# #BSUB -q "devhigh"
# #BSUB -J HIRESW_UNGRIB
# #BSUB -W 0:15
# #BSUB -cwd /gpfs/hps3/emc/meso/noscrub/Matthew.Pyle/
# #BSUB -P HRW-T2O
# #BSUB -M 3000
# #BSUB -extsched 'CRAYLINUX[]' -R '1*{select[craylinux && !vnode]} + 4*{select[craylinux && vnode]span[ptile=4] cu[type=cabinet]}' rusage[mem=3000]

#PBS -j oe 
#PBS -o /lfs/h2/emc/eib/noscrub/Matthew.Pyle/hiresw.v8.0.5/launch_info/logs/test_ungrib.out__DOM___CORE__CYC_
#PBS -e /lfs/h2/emc/eib/noscrub/Matthew.Pyle/hiresw.v8.0.5/launch_info/logs/test_ungrib.out__DOM___CORE__CYC_
#PBS -l select=1:ncpus=4:mem=8GB
#PBS -q dev
#PBS -l walltime=000:09:05


module purge
module load envvar/1.0
module load PrgEnv-intel/8.1.0

module load intel/19.1.3.304
module load craype/2.7.6
module load cray-mpich/8.1.4
module load prod_util
module load wgrib2

module load g2/3.4.1
module load g2tmpl/1.9.1

module load jasper/2.0.25
module load libpng/1.6.37
module load zlib/1.2.11



export NTASK=4
export PTILE=4

# vers=`cat /u/Matthew.Pyle/hiresw_version_test`

export HOMEhiresw=/lfs/h2/emc/eib/noscrub/Matthew.Pyle/hiresw.v8.0.5
export RUN_ENVIR=test
export envir=test
export NET=hiresw
export RUN=hiresw

export NEST=_DOM_
export cyc=_CYC_
export MODEL=_CORE_

export DATE=_DATE_
export PDY=$DATE

# export DATEroot=/gpfs/hps/nco/ops/com/date
# DATE=`cat $DATEroot/t${cyc}z | cut -c7-14`

DATEgfs=`$NDATE -6 ${DATE}${cyc} | cut -c1-8`
CYCgfs=`$NDATE -6 ${DATE}${cyc} | cut -c9-10`

echo DATEgfs $DATEgfs
echo CYCgfs $CYCgfs

COMINbase=/lfs/h1/ops/canned/com

export COMINgfs=${COMINbase}/gfs/v16.2/gfs.${DATEgfs}
export COMINnam=${COMINbase}/nam/v4.2/nam.${DATE}
export COMINnamold=${COMINbase}/nam/v4.2/nam.${DATEgfs}

export DATAROOT=/lfs/h2/emc/stmp/Matthew.Pyle/tmpnwprd
export MYCOMROOT=/lfs/h2/emc/ptmp/Matthew.Pyle/com

mkdir -p $DATAROOT
mkdir -p $MYCOMROOT

export COMOUT=${MYCOMROOT}/${NET}/$envir/${RUN}.${DATE}
export DATA=${DATAROOT}/hiresw.ungrib_${NEST}_${MODEL}_${cyc}_${envir}_retro

types="metgrid bufrpost bufrpostodd bufrposteven forecast post postodd posteven prdgen smartinit smartinitb"
for typ in $types
do
echo delete $typ
rm -rf ${DATAROOT}/hiresw.${typ}_${NEST}_${MODEL}_${cyc}_${envir}_retro
done

$HOMEhiresw/jobs/JHIRESW_UNGRIB

echo past J-job

qsub ${HOMEhiresw}/launch_info/sub_metgrid.lsf__DOM___CORE___CYC__retro
